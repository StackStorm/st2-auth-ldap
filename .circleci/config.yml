# Setup in CircleCI account the following ENV variables:
# IS_PRODUCTION (default: 0)
# IS_ENTERPRISE (default: 0)
# PACKAGECLOUD_ORGANIZATION (default: stackstorm)
# PACKAGECLOUD_TOKEN
defaults: &defaults
  working_directory: ~/ldap
  docker:
    - image: docker:18-git
  environment:
    DISTROS: wheezy jessie trusty xenial el6 el7
    docker_distros: wheezy centos6 centos7

version: 2
jobs:
  build:
    <<: *defaults
    environment:
      docker_run: |-
        docker run -w /code/${CIRCLE_PROJECT_REPONAME} -v ${PWD}:/code
          -e PKG_VERSION=\$PKG_VERSION
          -e PKG_RELEASE=\$PKG_RELEASE
    steps:
      - checkout
      - setup_remote_docker:
        docker_layer_caching: true
      - run:
        name: Install dependencies
        command: |
          sudo apt-get install jq
          gem install package_cloud
          make .clone_st2_repo
          make requirements
          cd ${CIRCLE_ARTIFACTS} && mkdir ${DISTROS}
      - run:
        name: Pull buildpacks
        command: |
          for dist in $docker_distros; do
            docker pull stackstorm/buildpack:$dist
          done
      - run:
        name: Setup circlerc_env
        command: |
          set -e
          PKG_VERSION=$(python setup.py --version 2>/dev/null)
          PKG_RELEASE=$(.circle/packagecloud.sh next-revision wheezy ${PKG_VERSION} st2-auth-ldap)
          circlerc_env PKG_VERSION PKG_RELEASE
      - run:
        name: Post checkout
        command: |
          .circle/circlerc.sh
          wget -qO - https:///github.com/StackStorm/st2-packages/raw/master/.circle/packagecloud.sh > .circle/packagecloud.sh
          chmod 755 .circle/packagecloud.sh
      - run:
        name: Make lint and unit tests
        command: |
          make .lint
          make .unit-tests
      - run:
        name: Build packages for supported distros on native OS inside stackstorm/buildpack container
        command: |
          eval ${docker_run} stackstorm/buildpack:wheezy make deb
          cp -r ../st2-auth-ldap_*.{deb,changes} $CIRCLE_ARTIFACTS/wheezy
          cp -r ../st2-auth-ldap_*.{deb,changes} $CIRCLE_ARTIFACTS/jessie
          cp -r ../st2-auth-ldap_*.{deb,changes} $CIRCLE_ARTIFACTS/trusty
          cp -r ../st2-auth-ldap_*.{deb,changes} $CIRCLE_ARTIFACTS/xenial
          eval ${docker_run} stackstorm/buildpack:centos6 make rpm
          sudo mv build/x86_64/st2-auth-ldap-*.rpm $CIRCLE_ARTIFACTS/el6
          eval ${docker_run} stackstorm/buildpack:centos7 make rpm
          sudo mv build/x86_64/st2-auth-ldap-*.rpm $CIRCLE_ARTIFACTS/el7
          #- run: 
          #name: Save images
          #command: |
      - persist_to_workspace:
        root: $CIRCLE_ARTIFACTS
        paths:
          - wheezy
          - jessie
          - trusty
          - xenial
          - el6
          - el7

  deploy:
    <<: *defaults
    steps:
      - checkout
      - setup_remote_docker:
        docker_layer_caching: true
      - attach_workspace:
        at: $CIRCLE_ARTIFACTS
      - run:
        name: Deploy to packagecloud
        command: |
          for distro in ${DISTROS}; do
            .circle/packagecloud.sh deploy $distro $CIRCLE_ARTIFACTS/$distro
          done

workflows:
  version: 2
  deploy-workflow:
    jobs:
      deploy:
        requires:
          - build
        filters:
          branches:
            only:
              - master
              - /v[0-9]+\.[0-9]+/
              - feature/circleci
