# Setup in CircleCI account the following ENV variables:
# IS_PRODUCTION (default: 0)
# IS_ENTERPRISE (default: 0)
# PACKAGECLOUD_ORGANIZATION (default: stackstorm)
# PACKAGECLOUD_TOKEN
machine:
  environment:
    DISTROS: "wheezy jessie trusty el6 el7"
    docker_run:  "docker run -w /code/${CIRCLE_PROJECT_REPONAME} -v ${PWD}:/code"
    packagecloud_cliuri: "https://github.com/StackStorm/st2-packages/raw/master/.circle/packagecloud.sh"
    IS_ENTERPRISE: 1
    DEPLOY_PACKAGES: 1
  services:
    - docker
  post:
    - cd ${CIRCLE_ARTIFACTS} && mkdir ${DISTROS}

checkout:
  post:
    - |
      # Download packagecloud.sh upload script
      wget -qO - ${packagecloud_cliuri} > .circle/packagecloud.sh
      chmod 755 .circle/packagecloud.sh
    - .circle/circlerc.sh
    - |
      set -e
      PKG_VERSION=$(python setup.py --version 2>/dev/null)
      PKG_RELEASE=$(.circle/packagecloud.sh next-revision trusty ${PKG_VERSION} st2-auth-ldap)
      circlerc_env PKG_VERSION PKG_RELEASE

dependencies:
  cache_directories:
    - ~/.cache/pip
  pre:
    - sudo apt-get install jq
    - gem install package_cloud
  override:
    - docker pull stackstorm/buildpack:wheezy
    - docker pull stackstorm/buildpack:jessie
    - docker pull stackstorm/buildpack:trusty
    - docker pull stackstorm/buildpack:centos6
    - docker pull stackstorm/buildpack:centos7

machine:
  environment:
    docker_run:  "docker run -w /code/${CIRCLE_PROJECT_REPONAME} -v ${PWD}:/code"
  services:
    - docker

test:
  pre:
    - ? |
        step tox -e lint; next
        step tox -e py27
      : parallel: true
  override:
    - |
      # deb build for wheezy, jessie, trusty
        ${docker_run} stackstorm/buildpack:wheezy dpkg-buildpackage -b -uc -us
        cp -r ../st2-auth-ldap_*.{deb,changes} $CIRCLE_ARTIFACTS/wheezy
        ${docker_run} stackstorm/buildpack:jessie dpkg-buildpackage -b -uc -us
        cp -r ../st2-auth-ldap_*.{deb,changes} $CIRCLE_ARTIFACTS/jessie
        ${docker_run} stackstorm/buildpack:trusty dpkg-buildpackage -b -uc -us
        cp -r ../st2-auth-ldap_*.{deb,changes} $CIRCLE_ARTIFACTS/trusty

    - |
      # rpm build for el6
        ${docker_run} stackstorm/buildpack:centos6 rpmbuild -bb rpm/st2-auth-ldap.spec
        sudo mv build/x86_64/st2-auth-ldap-*.rpm $CIRCLE_ARTIFACTS/el6 && sudo rm -rf build
    - | 
      # rpm build for el7
        ${docker_run} stackstorm/buildpack:centos7 rpmbuild -bb rpm/st2-auth-ldap.spec
        sudo mv build/x86_64/st2-auth-ldap-*.rpm $CIRCLE_ARTIFACTS/el7 && sudo rm -rf build

deployment:
  publish:
    branch:
      - master
      - feature/circleci
    owner: StackStorm
    commands:
      - |
        for distro in ${DISTROS}; do
          .circle/packagecloud.sh deploy $distro $CIRCLE_ARTIFACTS/$distro
        done
