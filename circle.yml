checkout:
  post:
    - .circle/circlerc.sh

dependencies:
  cache_directories:
    - ~/.cache/pip
  override:
    - ? |
        step 0 docker pull stackstorm/buildpack:centos6
        step 1 docker pull stackstorm/buildpack:centos7
      : parallel: true

machine:
  environment:
    docker_run:  "docker run -w /src -v ${PWD}/${CIRCLE_PROJECT_REPONAME}:/src"
  services:
    - docker

test:
  pre:
    - ? |
        step tox -e lint; next
        step tox -e py27
      : parallel: true
  override:
    - ? |
          step dpkg-buildpackage -b -uc -us
          step cp -r ../st2-auth-ldap_*.{deb,changes} $CIRCLE_ARTIFACTS
          step ${docker_run} stackstorm/buildpack:centos6 rpmbuild -bb rpm/st2-auth-ldap.spec
          step cp -r build/x86_64/st2-auth-ldap-*.rpm $CIRCLE_ARTIFACTS
          next
          step ${docker_run} stackstorm/buildpack:centos7 rpmbuild -bb rpm/st2-auth-ldap.spec
          step cp -r build/x86_64/st2-auth-ldap-*.rpm $CIRCLE_ARTIFACTS
      : parallel: true

deployment:
  publish:
    branch: master
    owner: StackStorm
    commands:
      - ? |
          step 0 ls -l $CIRCLE_ARTIFACTS
          step 1 ls -l $CIRCLE_ARTIFACTS
        : parallel: true
