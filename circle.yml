# Setup in CircleCI account the following ENV variables:
# IS_PRODUCTION (default: 0)
# IS_ENTERPRISE (default: 0)
# PACKAGECLOUD_ORGANIZATION (default: stackstorm)
# PACKAGECLOUD_TOKEN
machine:
  environment:
    DISTROS: "wheezy jessie trusty el6 el7"
    docker_run:  "docker run -w /src -v ${PWD}/${CIRCLE_PROJECT_REPONAME}:/src"
    ST2_PACKAGES_REPO: https://github.com/StackStorm/st2-packages
    IS_ENTERPRISE: 1
    DEPLOY_PACKAGES: 1
  services:
    - docker
  post:
    - cd ${CIRCLE_ARTIFACTS} && mkdir ${DISTROS}

checkout:
  post:
    - git clone --depth 1 ${ST2_PACKAGES_REPO} ~/st2-packages
    - .circle/circlerc.sh
    - |
      set -e
      PKG_VERSION=$(python setup.py --version 2>/dev/null)
      PKG_RELEASE=$(~/st2-packages/.circle/packagecloud.sh next-revision trusty ${PKG_VERSION} st2-auth-ldap)
      set -x
      echo "export PKG_VERSION=${PKG_VERSION}" >> ~/.circlerc
      echo "export PKG_RELEASE=${PKG_RELEASE}" >> ~/.circlerc

dependencies:
  cache_directories:
    - ~/.cache/pip
  pre:
    - sudo apt-get install parallel jq
    - gem install package_cloud
  override:
    - docker pull stackstorm/buildpack:jessie
    - docker pull stackstorm/buildpack:centos6
    - docker pull stackstorm/buildpack:centos7
    - docker pull stackstorm/buildpack:centos6
    - docker pull stackstorm/buildpack:centos7

machine:
  environment:
    docker_run:  "docker run -w /code/${CIRCLE_PROJECT_REPONAME} -v ${PWD}:/code"
  services:
    - docker

test:
  pre:
    - ? |
        step tox -e lint; next
        step tox -e py27
      : parallel: true
  override:
    # deb build for wheezy, jessie, trusty
    - |
      dpkg-buildpackage -b -uc -us
      cp -r ../st2-auth-ldap_*.{deb,changes} $CIRCLE_ARTIFACTS/wheezy
      cp -r ../st2-auth-ldap_*.{deb,changes} $CIRCLE_ARTIFACTS/jessie
      cp -r ../st2-auth-ldap_*.{deb,changes} $CIRCLE_ARTIFACTS/trusty
    # rpm build for el6
    - |
      ${docker_run} stackstorm/buildpack:centos6 rpmbuild -bb rpm/st2-auth-ldap.spec
      sudo mv build/x86_64/st2-auth-ldap-*.rpm $CIRCLE_ARTIFACTS/el6 && rm -rf build
    # rpm build for el7
    - |
      ${docker_run} stackstorm/buildpack:centos7 rpmbuild -bb rpm/st2-auth-ldap.spec
      sudo mv build/x86_64/st2-auth-ldap-*.rpm $CIRCLE_ARTIFACTS/el7 && rm -rf build

deployment:
  publish:
    branch:
      - master
      - feature/circleci
    owner: StackStorm
    commands:
      - "parallel -v -j0 --line-buffer ~/st2-packages/.circle/packagecloud.sh deploy {} $CIRCLE_ARTIFACTS/{} ::: ${DISTROS}"
