# Setup in CircleCI account the following ENV variables:
# IS_PRODUCTION (default: 0)
# IS_ENTERPRISE (default: 0)
# PACKAGECLOUD_ORGANIZATION (default: stackstorm)
# PACKAGECLOUD_TOKEN
machine:
  environment:
    IS_ENTERPRISE: 1
    DEPLOY_PACKAGES: 1
    DISTROS: wheezy jessie trusty xenial el6 el7
    docker_distros: wheezy centos6 centos7
    docker_run: |-
                  docker run -w /code/${CIRCLE_PROJECT_REPONAME} -v ${PWD}:/code
                    -e PKG_VERSION=\$PKG_VERSION
                    -e PKG_RELEASE=\$PKG_RELEASE
  services:
    - docker
  post:
    - cd ${CIRCLE_ARTIFACTS} && mkdir ${DISTROS}

dependencies:
  cache_directories:
    - ~/.cache/pip
  pre:
    - sudo apt-get install jq
    - gem install package_cloud
    - make requirements
  override:
    - |
        # Don't do heavy operation on all test nodes, only on 0 (step invocation)
        for dist in $docker_distros; do
          step docker pull stackstorm/buildpack:$dist
        done
    - |
        set -e
        PKG_VERSION=$(python setup.py --version 2>/dev/null)
        PKG_RELEASE=$(.circle/packagecloud.sh next-revision wheezy ${PKG_VERSION} st2-auth-ldap)
        circlerc_env PKG_VERSION PKG_RELEASE

checkout:
  post:
    - .circle/circlerc.sh
    - |
        # Download packagecloud.sh upload script
        wget -qO - https://github.com/StackStorm/st2-packages/raw/master/.circle/packagecloud.sh > .circle/packagecloud.sh
        chmod 755 .circle/packagecloud.sh

test:
  pre:
    - make play .lint .unit-tests
  override:
    # Build packages for supported distros on native OS inside stackstorm/buildpack container.
    - |
        eval ${docker_run} stackstorm/buildpack:wheezy make deb
        cp -r ../st2-auth-ldap_*.{deb,changes} $CIRCLE_ARTIFACTS/wheezy
        cp -r ../st2-auth-ldap_*.{deb,changes} $CIRCLE_ARTIFACTS/jessie
        cp -r ../st2-auth-ldap_*.{deb,changes} $CIRCLE_ARTIFACTS/trusty
        cp -r ../st2-auth-ldap_*.{deb,changes} $CIRCLE_ARTIFACTS/xenial
    - |
        eval ${docker_run} stackstorm/buildpack:centos6 make rpm
        sudo mv build/x86_64/st2-auth-ldap-*.rpm $CIRCLE_ARTIFACTS/el6
    - |
        eval ${docker_run} stackstorm/buildpack:centos7 make rpm
        sudo mv build/x86_64/st2-auth-ldap-*.rpm $CIRCLE_ARTIFACTS/el7

deployment:
  publish:
    branch:
      - master
      - /v[0-9]+\.[0-9]+/
      - feature/circleci
    owner: StackStorm
    commands:
      - |
          for distro in ${DISTROS}; do
            .circle/packagecloud.sh deploy $distro $CIRCLE_ARTIFACTS/$distro
          done
